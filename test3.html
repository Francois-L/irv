<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8" />
  <title>Le titre du document</title>
    <link rel="stylesheet" type="text/css" href="bootstrap-3.3.7/dist/css/bootstrap.min.css" />
	<link rel="stylesheet" type="text/css" href="bootstrap-datepicker-1.6.4-dist/css/bootstrap-datepicker.min.css" />
	<script src="jquery-3.1.1.js"></script>
	<script src="bootstrap-3.3.7/dist/js/bootstrap.min.js"></script>
	<script src="bootstrap-datepicker-1.6.4-dist/js/bootstrap-datepicker.min.js"></script>
	<script src="bootstrap-datepicker-1.6.4-dist/locales/bootstrap-datepicker.fr.min.js"></script>

	
</head>

<body>

  <div class="container">
    <header class="page-header">
  	  <h1>Illdo</h1>
  	  <h2>Réaliser.</h2>
    </header>
  </div>


<div class="container">
	<div class="row">
		<div class="col-lg-12">
			<form id="form1" class="generate" method="post" action="save-objectifs.php">
				<input type="text" name="objectif" class="generate-input" placeholder="Objectif" maxlength="35" />
				<input type="text" id="datepicker" class="generate-input" placeholder="Fin" />
				<input type="hidden" name="sendObjectif" id="sendObjectif" />
				<input type="hidden" name="sendDate" id="sendDate" />
				<input type="button" id="submitButton" class="generate-submit" value="Créer l'objectif" />
			</form>
		</div>
	</div>
</div>

<div class="container">
	<section class="row">
    <div id="links">
	  </div>
	  <div id="links2">
	  </div>
	</section>
</div>




<script>


$(function() {
    $("#datepicker").datepicker({language:'fr'});
    $("#datepicker").on("change",function(){
        var selected = $(this).val();
    });
});

(function(){

	var $ = function (selector) {
		return document.querySelector(selector);
	};
	var links = $('#links').getElementsByTagName('div');

	var div = links[i];
	for (var i = 0; i < links.length; i++) {
	}

	$('#submitButton').onclick = function() {
		var dynamicValue1 = $('.generate-input').value;
		var dynamicValue2 = $('#datepicker').value;
		
		if(!dynamicValue1 || !dynamicValue2) {
			alert('Veuillez remplir les 2 champs');
		}
		else {
			var newDiv = document.createElement('div');
			newDiv.innerHTML = 'Sauvegarde en cours...';
			newDiv.className = 'col-xs-6 col-sm-4 col-md-3 col-lg-3';
			$('#links').appendChild(newDiv);
			
			var sendObjectif = dynamicValue1;
			var sendDate = dynamicValue2;
			
			var sendDate = sendDate.split('/');
			var sendDate = (sendDate[2] + '-' + sendDate[1] + '-' + sendDate[0]); 
			
			document.getElementById('sendObjectif').value = sendObjectif;
			document.getElementById('sendDate').value = sendDate;

			jQuery.post("save-objectifs.php",
				{
				  sendObjectif: sendObjectif,
				  sendDate: sendDate
				},
				function(response, status) {
					console.log('response', response);
					console.log('status', status);
					var id = response.id;
					newDiv.innerHTML = '<p data-id-objectifdate="'+ id +'">' + dynamicValue1 + '<br />' + dynamicValue2 + '</p><ul style="display:none"><li data-id-over="'+ id +'">Terminé</li><li data-id-delete="'+ id +'">Supprimer</li></ul><img id="working'+ id +'" src="logo.png" />';
					newDiv.setAttribute("id", "box_"+ id);
					jQuery('p[data-id-objectifdate='+id+']').click(toggleMenu);
					jQuery('li[data-id-over='+id+']').click(overObjectif);
					jQuery('li[data-id-delete='+id+']').click(deleteObjectif);
				  console.log("ça marche !", response);
				}, 
				'json'
			);
			location.reload();
		}
	}
})();

function toggleMenu() {
    var menuBox = jQuery(this).parent().find('ul');
    if (menuBox.is(':visible')) { menuBox.slideUp(); }
    else { menuBox.slideDown() };
}

function overObjectif() {
	console.log('[start] overObjectif', jQuery(this));
	var id = jQuery(this).data('id-over');
	var agree = confirm("L'objectif "+ id +" est terminé ?");
	if (agree) {
		alert('ok');
	}
	else {
		return false;
	}
}

function deleteObjectif() {
	console.log('[start] deleteObjectif', jQuery(this));
	var id = jQuery(this).data('id-delete');
	var agree = confirm("Supprimer cet objectif "+ id +" ?");
	if (agree) {
		$(this).parent().parent().remove();
		jQuery.ajax({
			type: "POST",
			url: "remove-objectifs.php",
			data: "id=" + id,
			cache: false,
			success: function(response, status) {
				console.log("supprimé ! " + id, response);
			}
		});
	}
	else {
		return false;
	}
}




$(function () {
    $('#my_form').on('submit', function (e) {
        // On empêche le navigateur de soumettre le formulaire
        e.preventDefault();
 
        var $form = $(this);
        var formdata = (window.FormData) ? new FormData($form[0]) : null;
        var data = (formdata !== null) ? formdata : $form.serialize();
 
        $.ajax({
            url: $form.attr('action'),
            type: $form.attr('method'),
            contentType: false, // obligatoire pour de l'upload
            processData: false, // obligatoire pour de l'upload
            dataType: 'json', // selon le retour attendu
            data: data,
            success: function (response) {
                // La réponse du serveur
            }
        });
    });
});







/*	$(document).ready(function (e){
		$("div[id^='uploadimage-']").on('submit',function(e) {
			e.preventDefault();
			console.log('ok');
			jQuery.post({
				url: "save-pictures.php", // Url to which the request is send
				type: "POST",             // Type of request to be send, called as method
				data: new FormData(this), // Data sent to server, a set of key/value pairs (i.e. form fields and values)
				contentType: false,       // The content type used when sending data to the server.
				cache: false,             // To unable request pages to be cached
				processData:false,        // To send DOMDocument or non processed data file it is set to false
				success: function(data)   // A function to be called if request succeeds
				{
					$('#msg').html(data);
					console.log("envoyé" + id, response);
				}
			});
		});
	});
*/

$(document).ready(function() {
	$("#links2").load("load-objectifs.php", function() {
         // console.log("Les objectifs sont chargés");
         // console.log("on met à jour les <li> suivants :", jQuery("li[id^='delete-']"));
		  jQuery("p[id^='objectifdate-']").click(toggleMenu);
 		  jQuery("li[id^='delete-']").click(deleteObjectif);
		  jQuery("li[id^='over-']").click(overObjectif);
        });
});

</script>


</body>
</html>
